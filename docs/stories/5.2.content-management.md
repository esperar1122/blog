# Story 5.2: Content Management

## Status

Done

## Story
**As a** 系统管理员，
**I want** 能够管理系统内容，
**so that** 确保内容质量和系统合规。

## Acceptance Criteria
1. 实现内容列表API，支持文章和评论的统一管理
2. 创建内容管理页面，显示所有文章和评论
3. 实现文章审核功能，管理员可以审核和修改文章
4. 实现批量操作功能，支持批量删除、批量修改状态
5. 创建内容统计页面，显示文章数量、评论数量等数据
6. 实现内容导出功能，支持导出文章数据
7. 创建敏感词管理功能，配置和管理敏感词列表
8. 实现系统设置功能，配置系统参数和规则

## Tasks / Subtasks
- [x] Task 1: 实现后端内容管理API (AC: 1, 3, 4, 6, 7, 8)
  - [x] Subtask 1.1: 创建AdminContentController，实现内容列表查询API（文章和评论）
  - [x] Subtask 1.2: 实现文章审核API，支持审核和修改文章内容
  - [x] Subtask 1.3: 实现批量操作API，支持批量删除和状态修改
  - [x] Subtask 1.4: 实现内容导出API，支持JSON和CSV格式导出
  - [x] Subtask 1.5: 创建敏感词管理API（CRUD操作）
  - [x] Subtask 1.6: 实现系统设置API，管理系统参数配置
  - [x] Subtask 1.7: 创建AdminContentService实现业务逻辑
  - [x] Subtask 1.8: 实现敏感词过滤和内容检查功能

- [x] Task 2: 创建前端内容管理页面 (AC: 2, 3, 4, 5, 7, 8)
  - [x] Subtask 2.1: 创建ContentManagement.vue组件，包含内容切换标签（文章/评论）
  - [x] Subtask 2.2: 实现文章管理界面，显示文章列表和操作按钮
  - [x] Subtask 2.3: 创建文章审核对话框，支持预览和编辑文章内容
  - [x] Subtask 2.4: 实现批量操作界面（选择、批量删除、状态修改）
  - [x] Subtask 2.5: 创建内容统计展示组件（ContentStats.vue）
  - [x] Subtask 2.6: 实现内容导出功能，支持选择格式和下载
  - [x] Subtask 2.7: 创建敏感词管理界面（SensitiveWordManagement.vue）
  - [x] Subtask 2.8: 实现系统设置页面（SystemSettings.vue）

- [x] Task 3: 实现内容搜索和筛选功能 (AC: 1, 2)
  - [x] Subtask 3.1: 实现文章搜索功能（按标题、内容、作者、分类）
  - [x] Subtask 3.2: 实现评论搜索功能（按内容、作者、文章）
  - [x] Subtask 3.3: 实现高级筛选功能（按状态、时间范围、分类）
  - [x] Subtask 3.4: 创建搜索结果排序功能

- [x] Task 4: 创建路由和权限控制 (AC: 全部)
  - [x] Subtask 4.1: 添加管理员路由配置 /admin/content
  - [x] Subtask 4.2: 实现管理员权限验证
  - [x] Subtask 4.3: 添加路由守卫，确保只有管理员可访问

- [x] Task 5: 创建单元测试 (AC: 全部)
  - [x] Subtask 5.1: 为AdminContentController编写单元测试
  - [x] Subtask 5.2: 为AdminContentService编写单元测试
  - [x] Subtask 5.3: 为前端ContentManagement组件编写单元测试
  - [x] Subtask 5.4: 编写集成测试验证API功能

## Dev Notes

### Previous Story Insights
从之前的故事中学习到：
- 需要始终遵循JWT认证机制，在Controller层使用@PreAuthorize注解
- 遵循统一的API响应格式和错误处理机制
- 前端组件需要使用Element Plus组件库保持UI一致性
- 所有数据库操作需要使用MyBatis Plus提供的CRUD方法
- 管理员操作需要记录审计日志到t_admin_log表

### Data Models
**Article实体模型** [Source: architecture/data-models.md#Article]
```typescript
interface Article {
  id: number;
  title: string;
  content: string;
  summary?: string;
  coverImage?: string;
  status: 'DRAFT' | 'PUBLISHED' | 'DELETED';
  viewCount: number;
  likeCount: number;
  commentCount: number;
  isTop: boolean;
  authorId: number;
  categoryId: number;
  createTime: string;
  updateTime: string;
  publishTime?: string;
}
```

**Comment实体模型** [Source: architecture/data-models.md#Comment]
```typescript
interface Comment {
  id: number;
  content: string;
  articleId: number;
  userId: number;
  parentId?: number;
  level: number;
  likeCount: number;
  status: 'NORMAL' | 'DELETED';
  createTime: string;
  updateTime: string;
}
```

**文章状态枚举**：
- DRAFT: 草稿状态
- PUBLISHED: 已发布
- DELETED: 已删除（逻辑删除）

**评论状态枚举**：
- NORMAL: 正常状态
- DELETED: 已删除（逻辑删除）

### API Specifications
**管理员内容管理API** [Source: architecture/api-specification.md#Admin-endpoints]

GET /admin/content/articles
- 描述：获取所有文章列表（管理员视图）
- 权限：需要管理员权限
- 参数：
  - page: 页码（默认0）
  - size: 每页数量（默认20）
  - status: 状态筛选（DRAFT/PUBLISHED/DELETED）
  - keyword: 搜索关键词（搜索标题、内容、作者）
  - categoryId: 分类ID筛选
  - startTime: 开始时间
  - endTime: 结束时间

GET /admin/content/comments
- 描述：获取所有评论列表（管理员视图）
- 权限：需要管理员权限
- 参数：
  - page: 页码（默认0）
  - size: 每页数量（默认20）
  - status: 状态筛选（NORMAL/DELETED）
  - keyword: 搜索关键词
  - articleId: 文章ID筛选
  - startTime: 开始时间
  - endTime: 结束时间

PUT /admin/content/articles/{id}/review
- 描述：审核和修改文章
- 权限：需要管理员权限
- 请求体：文章内容（title, content, summary, status等）

POST /admin/content/batch-operation
- 描述：批量操作（删除、状态修改）
- 权限：需要管理员权限
- 请求体：操作类型和ID列表

GET /admin/content/export
- 描述：导出内容数据
- 权限：需要管理员权限
- 参数：
  - type: 导出类型（articles/comments）
  - format: 导出格式（json/csv）
  - filters: 筛选条件

### Component Specifications
**ContentManagement组件** [Source: architecture/frontend-architecture.md#Component-Organization]
- 位置：src/components/admin/ContentManagement.vue
- 功能：
  - 内容切换标签（文章/评论管理）
  - 内容列表展示（使用el-table）
  - 搜索和筛选（使用el-form和el-input）
  - 批量操作界面（批量选择、操作按钮）
  - 内容审核对话框（使用el-dialog）

**文章管理表格列**：
- 复选框（批量操作）
- 文章标题和封面
- 作者信息（用户名、昵称）
- 分类和标签
- 状态（状态标签）
- 统计数据（浏览量、点赞数、评论数）
- 创建时间
- 操作列（编辑、审核、删除按钮）

**评论管理表格列**：
- 复选框（批量操作）
- 评论内容（截断显示）
- 评论者信息
- 所属文章
- 状态（状态标签）
- 点赞数
- 评论时间
- 操作列（查看、删除按钮）

### File Locations
**后端文件位置** [Source: architecture/unified-project-structure.md]:
```
blog-backend/src/main/java/com/example/blog/
├── controller/
│   └── AdminContentController.java
├── service/
│   ├── AdminContentService.java
│   ├── SensitiveWordService.java
│   ├── SystemSettingsService.java
│   └── impl/
│       ├── AdminContentServiceImpl.java
│       ├── SensitiveWordServiceImpl.java
│       └── SystemSettingsServiceImpl.java
├── entity/
│   ├── SensitiveWord.java
│   └── SystemSettings.java
├── dto/
│   ├── request/
│   │   ├── ContentQueryRequest.java
│   │   ├── ArticleReviewRequest.java
│   │   ├── BatchOperationRequest.java
│   │   └── SystemSettingsRequest.java
│   └── response/
│       ├── ContentStatsResponse.java
│       └── ExportResponse.java
└── repository/
    ├── SensitiveWordRepository.java
    └── SystemSettingsRepository.java
```

**前端文件位置** [Source: architecture/unified-project-structure.md]:
```
blog-frontend/src/
├── views/admin/
│   └── ContentManagement.vue
├── components/admin/
│   ├── ContentManagement.vue
│   ├── ArticleManagement.vue
│   ├── CommentManagement.vue
│   ├── ContentStats.vue
│   ├── ArticleReviewDialog.vue
│   ├── SensitiveWordManagement.vue
│   └── SystemSettings.vue
└── services/
    ├── adminContentService.ts
    └── adminSettingsService.ts
```

### Testing Requirements
**测试标准** [Source: architecture/testing-strategy.md#Test-Organization]

**后端测试**：
- 位置：src/test/java/com/example/blog/controller/AdminContentControllerTest.java
- 使用 @WebMvcTest 和 @Import(SecurityConfig.class)
- 测试所有API端点的权限验证
- 测试内容搜索和筛选功能
- 测试批量操作逻辑
- 测试敏感词过滤功能

**前端测试**：
- 位置：tests/unit/components/admin/ContentManagement.spec.ts
- 使用 Vue Test Utils 和 Vitest
- 测试组件渲染和数据绑定
- 测试内容审核功能
- 测试批量操作交互
- 测试搜索和筛选功能

**测试框架**：
- 后端：JUnit 5 + Mockito [Source: architecture/tech-stack.md#Backend-Testing]
- 前端：Vitest + Vue Test Utils [Source: architecture/tech-stack.md#Frontend-Testing]

### Technical Constraints
**认证和授权** [Source: architecture/backend-architecture.md#Authentication-and-Authorization]:
- 所有管理员API必须使用 @PreAuthorize("hasRole('ADMIN')")
- JWT token验证通过JwtAuthenticationFilter自动处理
- 管理员权限检查在Service层进行二次验证

**性能要求**：
- 内容列表API支持分页，默认每页20条
- 搜索功能支持索引优化（title, content字段）
- 批量操作需要事务支持
- 内容导出需要异步处理，避免超时

**安全要求** [Source: architecture/security-and-performance.md#Security-Requirements]:
- 删除内容默认为逻辑删除，保留数据完整性
- 敏感词过滤在内容创建和更新时执行
- 所有管理操作必须记录审计日志
- 批量操作需要二次确认
- 内容导出需要权限检查和数据脱敏

### Project Structure Notes
项目结构遵循统一的项目结构规范 [Source: architecture/unified-project-structure.md]。需要创建的文件都已在上述File Locations中明确标注，遵循标准的MVC架构模式。

### Database Schema
**现有表结构** [Source: architecture/database-schema.md]:
- t_article表已包含所有必要字段
- t_comment表已包含所有必要字段
- 需要添加索引：idx_title_content, idx_create_time用于优化搜索

**新增表结构**：
```sql
-- 敏感词表
CREATE TABLE t_sensitive_word (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    word VARCHAR(100) NOT NULL UNIQUE COMMENT '敏感词',
    type ENUM('WORD', 'REGEX') NOT NULL DEFAULT 'WORD' COMMENT '类型',
    level ENUM('LOW', 'MEDIUM', 'HIGH') NOT NULL DEFAULT 'MEDIUM' COMMENT '级别',
    status ENUM('ACTIVE', 'INACTIVE') NOT NULL DEFAULT 'ACTIVE' COMMENT '状态',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_word (word),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='敏感词表';

-- 系统设置表
CREATE TABLE t_system_settings (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    setting_key VARCHAR(100) NOT NULL UNIQUE COMMENT '设置键',
    setting_value TEXT COMMENT '设置值',
    description VARCHAR(500) COMMENT '设置描述',
    type ENUM('STRING', 'NUMBER', 'BOOLEAN', 'JSON') NOT NULL DEFAULT 'STRING' COMMENT '值类型',
    is_public BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否公开',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_key (setting_key),
    INDEX idx_public (is_public)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统设置表';
```

## Testing

### Test Requirements
1. **Backend Unit Tests**
   - AdminContentController所有API端点测试
   - AdminContentService业务逻辑测试
   - SensitiveWordService敏感词过滤测试
   - 权限验证测试
   - 批量操作功能测试

2. **Frontend Unit Tests**
   - ContentManagement组件渲染测试
   - 内容管理交互功能测试
   - 文章审核对话框测试
   - 批量操作UI测试
   - 搜索和筛选功能测试

3. **Integration Tests**
   - API端到端测试
   - 内容管理工作流测试
   - 敏感词过滤集成测试
   - 数据一致性测试

4. **E2E Tests**
   - 管理员登录并访问内容管理页面
   - 搜索和筛选文章/评论
   - 审核和修改文章内容
   - 执行批量删除操作
   - 配置敏感词和系统设置

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-16 | 1.0 | Initial story creation | Scrum Master |
| 2025-12-16 | 2.0 | Complete implementation of content management features | Dev Agent (Claude Sonnet 4.5) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20251101)

### Debug Log References
无调试日志 - 所有功能按预期实现完成

### Completion Notes List
1. **后端API实现完整**: 所有内容管理相关的REST API已成功实现，包括文章/评论查询、审核、批量操作、导出、敏感词管理和系统设置
2. **前端组件功能完善**: 创建了完整的内容管理界面，包括文章管理、评论管理、敏感词管理、系统设置等功能模块
3. **权限控制严格**: 所有管理员功能都配置了正确的权限验证，确保只有管理员可以访问
4. **测试覆盖全面**: 编写了单元测试、集成测试，覆盖了主要功能的验证
5. **代码规范遵循**: 严格遵循了项目的编码规范和架构设计原则

### File List

#### 后端文件
**Controllers:**
- `blog-backend/src/main/java/com/example/blog/controller/AdminContentController.java` - 内容管理主控制器

**Services:**
- `blog-backend/src/main/java/com/example/blog/service/AdminContentService.java` - 内容管理服务接口
- `blog-backend/src/main/java/com/example/blog/service/AdminLogService.java` - 管理员日志服务接口
- `blog-backend/src/main/java/com/example/blog/service/SensitiveWordService.java` - 敏感词管理服务接口
- `blog-backend/src/main/java/com/example/blog/service/SystemSettingsService.java` - 系统设置服务接口

**Service Implementations:**
- `blog-backend/src/main/java/com/example/blog/service/impl/AdminContentServiceImpl.java` - 内容管理服务实现
- `blog-backend/src/main/java/com/example/blog/service/impl/AdminLogServiceImpl.java` - 管理员日志服务实现
- `blog-backend/src/main/java/com/example/blog/service/impl/SensitiveWordServiceImpl.java` - 敏感词管理服务实现
- `blog-backend/src/main/java/com/example/blog/service/impl/SystemSettingsServiceImpl.java` - 系统设置服务实现

**DTOs:**
- `blog-backend/src/main/java/com/example/blog/dto/request/ContentQueryRequest.java` - 内容查询请求DTO
- `blog-backend/src/main/java/com/example/blog/dto/request/ArticleReviewRequest.java` - 文章审核请求DTO
- `blog-backend/src/main/java/com/example/blog/dto/request/BatchOperationRequest.java` - 批量操作请求DTO
- `blog-backend/src/main/java/com/example/blog/dto/request/SystemSettingsRequest.java` - 系统设置请求DTO
- `blog-backend/src/main/java/com/example/blog/dto/response/ContentStatsResponse.java` - 内容统计响应DTO
- `blog-backend/src/main/java/com/example/blog/dto/response/ExportResponse.java` - 导出响应DTO

**Entities:**
- `blog-backend/src/main/java/com/example/blog/entity/SensitiveWord.java` - 敏感词实体
- `blog-backend/src/main/java/com/example/blog/entity/SystemSettings.java` - 系统设置实体

**Mappers:**
- `blog-backend/src/main/java/com/example/blog/mapper/SensitiveWordMapper.java` - 敏感词Mapper接口
- `blog-backend/src/main/java/com/example/blog/mapper/SystemSettingsMapper.java` - 系统设置Mapper接口

**Tests:**
- `blog-backend/src/test/java/com/example/blog/controller/AdminContentControllerTest.java` - 管理员内容控制器单元测试
- `blog-backend/src/test/java/com/example/blog/service/AdminContentServiceTest.java` - 内容管理服务单元测试
- `blog-backend/src/test/java/com/example/blog/integration/AdminContentIntegrationTest.java` - 内容管理集成测试

#### 前端文件
**Views:**
- `blog-frontend/src/views/admin/AdminDashboard.vue` - 管理员控制台主页面

**Components:**
- `blog-frontend/src/components/admin/ContentManagement.vue` - 内容管理主组件
- `blog-frontend/src/components/admin/ArticleReviewDialog.vue` - 文章审核对话框
- `blog-frontend/src/components/admin/ExportDialog.vue` - 导出对话框
- `blog-frontend/src/components/admin/ContentStats.vue` - 内容统计组件
- `blog-frontend/src/components/admin/SensitiveWordManagement.vue` - 敏感词管理组件
- `blog-frontend/src/components/admin/SensitiveWordDialog.vue` - 敏感词编辑对话框
- `blog-frontend/src/components/admin/ContentTestDialog.vue` - 内容测试对话框
- `blog-frontend/src/components/admin/SystemSettings.vue` - 系统设置组件

**Services:**
- `blog-frontend/src/services/adminContentService.ts` - 内容管理API服务

**Tests:**
- `blog-frontend/tests/unit/components/admin/ContentManagement.spec.ts` - 内容管理组件单元测试

#### 配置文件
- `blog-frontend/src/router/index.ts` - 更新了路由配置，添加了管理员内容管理路由

## QA Results

### Review Date: [To be filled by QA Agent]

### Reviewed By: [To be filled by QA Agent]

### Code Quality Assessment
[To be filled by QA Agent]

### Refactoring Performed
[To be filled by QA Agent]

### Compliance Check
- Coding Standards: [To be assessed]
- Project Structure: [To be assessed]
- Testing Strategy: [To be assessed]
- All ACs Met: [To be assessed]

### Improvements Checklist
[To be filled by QA Agent]

### Security Review
[To be filled by QA Agent]

### Performance Considerations
[To be filled by QA Agent]

### Files Modified During Review
[To be filled by QA Agent]

### Gate Status
[To be filled by QA Agent]

### Recommended Status
[To be filled by QA Agent]