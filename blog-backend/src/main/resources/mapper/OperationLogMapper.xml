<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.blog.mapper.OperationLogMapper">

    <!-- 分页查询操作日志 -->
    <select id="selectLogPage" resultType="com.example.blog.entity.OperationLog">
        SELECT * FROM t_operation_log
        <where>
            <if test="request.username != null and request.username != ''">
                AND username LIKE CONCAT('%', #{request.username}, '%')
            </if>
            <if test="request.operation != null and request.operation != ''">
                AND operation LIKE CONCAT('%', #{request.operation}, '%')
            </if>
            <if test="request.method != null and request.method != ''">
                AND method LIKE CONCAT('%', #{request.method}, '%')
            </if>
            <if test="request.ip != null and request.ip != ''">
                AND ip = #{request.ip}
            </if>
            <if test="request.status != null">
                AND status = #{request.status}
            </if>
            <if test="request.startTime != null">
                AND create_time >= #{request.startTime}
            </if>
            <if test="request.endTime != null">
                AND create_time &lt;= #{request.endTime}
            </if>
            <if test="request.keyword != null and request.keyword != ''">
                AND (operation LIKE CONCAT('%', #{request.keyword}, '%')
                OR method LIKE CONCAT('%', #{request.keyword}, '%')
                OR username LIKE CONCAT('%', #{request.keyword}, '%')
                OR result LIKE CONCAT('%', #{request.keyword}, '%'))
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 根据时间范围删除日志 -->
    <delete id="deleteByTimeRange">
        DELETE FROM t_operation_log
        WHERE create_time >= #{startTime} AND create_time &lt;= #{endTime}
    </delete>

    <!-- 统计操作日志数量 -->
    <select id="countByOperation" resultType="map">
        SELECT operation, COUNT(*) as count
        FROM t_operation_log
        GROUP BY operation
        ORDER BY count DESC
        LIMIT 10
    </select>

    <!-- 统计用户操作数量 -->
    <select id="countByUser" resultType="map">
        SELECT username, COUNT(*) as count
        FROM t_operation_log
        WHERE username IS NOT NULL
        GROUP BY username
        ORDER BY count DESC
        LIMIT 10
    </select>

    <!-- 获取今日操作统计 -->
    <select id="getTodayStats" resultType="map">
        SELECT
            COUNT(*) as total,
            SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) as success,
            SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) as failure,
            AVG(time) as avgTime
        FROM t_operation_log
        WHERE DATE(create_time) = CURDATE()
    </select>

    <!-- 获取最近N天的操作趋势 -->
    <select id="getOperationTrend" resultType="map">
        SELECT
            DATE(create_time) as date,
            COUNT(*) as count,
            SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) as success,
            SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) as failure
        FROM t_operation_log
        WHERE create_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        GROUP BY DATE(create_time)
        ORDER BY date DESC
    </select>

</mapper>