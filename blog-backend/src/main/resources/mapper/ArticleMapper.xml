<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.blog.mapper.ArticleMapper">

    <resultMap id="ArticleWithDetailsMap" type="com.example.blog.entity.Article">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="summary" property="summary"/>
        <result column="cover_image" property="coverImage"/>
        <result column="status" property="status"/>
        <result column="view_count" property="viewCount"/>
        <result column="like_count" property="likeCount"/>
        <result column="comment_count" property="commentCount"/>
        <result column="is_top" property="isTop"/>
        <result column="author_id" property="authorId"/>
        <result column="category_id" property="categoryId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="publish_time" property="publishTime"/>
        <result column="author_name" property="authorName"/>
        <result column="author_avatar" property="authorAvatar"/>
        <result column="category_name" property="categoryName"/>
        <collection property="tags" ofType="com.example.blog.entity.Tag">
            <id column="tag_id" property="id"/>
            <result column="tag_name" property="name"/>
            <result column="tag_create_time" property="createTime"/>
        </collection>
    </resultMap>

    <!-- 查询文章列表（包含详细信息） -->
    <select id="selectArticlesWithDetails" resultMap="ArticleWithDetailsMap">
        SELECT
            a.id, a.title, a.summary, a.cover_image, a.status,
            a.view_count, a.like_count, a.comment_count, a.is_top,
            a.author_id, a.category_id, a.create_time, a.update_time, a.publish_time,
            u.username as author_name, u.avatar as author_avatar,
            c.name as category_name,
            t.id as tag_id, t.name as tag_name, t.create_time as tag_create_time
        FROM t_article a
        LEFT JOIN t_user u ON a.author_id = u.id
        LEFT JOIN t_category c ON a.category_id = c.id
        LEFT JOIN t_article_tag at ON a.id = at.article_id
        LEFT JOIN t_tag t ON at.tag_id = t.id
        WHERE a.status != 'DELETED'
        <if test="categoryId != null">
            AND a.category_id = #{categoryId}
        </if>
        <if test="tagId != null">
            AND EXISTS (SELECT 1 FROM t_article_tag at2 WHERE at2.article_id = a.id AND at2.tag_id = #{tagId})
        </if>
        <if test="keyword != null and keyword != ''">
            AND (a.title LIKE CONCAT('%', #{keyword}, '%') OR a.summary LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="status != null and status != ''">
            AND a.status = #{status}
        </if>
        ORDER BY a.is_top DESC, a.create_time DESC
    </select>

    <!-- 查询单篇文章详情 -->
    <select id="selectArticleWithDetails" resultMap="ArticleWithDetailsMap">
        SELECT
            a.id, a.title, a.content, a.summary, a.cover_image, a.status,
            a.view_count, a.like_count, a.comment_count, a.is_top,
            a.author_id, a.category_id, a.create_time, a.update_time, a.publish_time,
            u.username as author_name, u.avatar as author_avatar,
            c.name as category_name,
            t.id as tag_id, t.name as tag_name, t.create_time as tag_create_time
        FROM t_article a
        LEFT JOIN t_user u ON a.author_id = u.id
        LEFT JOIN t_category c ON a.category_id = c.id
        LEFT JOIN t_article_tag at ON a.id = at.article_id
        LEFT JOIN t_tag t ON at.tag_id = t.id
        WHERE a.id = #{id} AND a.status != 'DELETED'
    </select>

    <!-- 查询作者文章列表 -->
    <select id="selectArticlesByAuthor" resultType="com.example.blog.entity.Article">
        SELECT id, title, summary, cover_image, status, view_count, like_count, comment_count,
               is_top, author_id, category_id, create_time, update_time, publish_time
        FROM t_article
        WHERE author_id = #{authorId}
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY create_time DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询热门文章 -->
    <select id="selectPopularArticles" resultType="com.example.blog.entity.Article">
        SELECT id, title, summary, cover_image, view_count, like_count, comment_count,
               is_top, author_id, category_id, create_time, publish_time
        FROM t_article
        WHERE status = 'PUBLISHED'
        ORDER BY view_count DESC, like_count DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询最新文章 -->
    <select id="selectLatestArticles" resultType="com.example.blog.entity.Article">
        SELECT id, title, summary, cover_image, view_count, like_count, comment_count,
               is_top, author_id, category_id, create_time, publish_time
        FROM t_article
        WHERE status = 'PUBLISHED'
        ORDER BY publish_time DESC, create_time DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询相关文章 -->
    <select id="selectRelatedArticles" resultType="com.example.blog.entity.Article">
        SELECT id, title, summary, cover_image, view_count, like_count, comment_count,
               is_top, author_id, category_id, create_time, publish_time
        FROM t_article
        WHERE status = 'PUBLISHED'
        AND id != #{id}
        AND category_id = #{categoryId}
        ORDER BY view_count DESC, create_time DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 增加浏览次数 -->
    <update id="incrementViewCount">
        UPDATE t_article
        SET view_count = IFNULL(view_count, 0) + 1
        WHERE id = #{id}
    </update>

    <!-- 增加点赞次数 -->
    <update id="incrementLikeCount">
        UPDATE t_article
        SET like_count = IFNULL(like_count, 0) + 1
        WHERE id = #{id}
    </update>

    <!-- 减少点赞次数 -->
    <update id="decrementLikeCount">
        UPDATE t_article
        SET like_count = GREATEST(0, IFNULL(like_count, 0) - 1)
        WHERE id = #{id}
    </update>

    <!-- 增加评论次数 -->
    <update id="incrementCommentCount">
        UPDATE t_article
        SET comment_count = IFNULL(comment_count, 0) + 1
        WHERE id = #{id}
    </update>

    <!-- 减少评论次数 -->
    <update id="decrementCommentCount">
        UPDATE t_article
        SET comment_count = GREATEST(0, IFNULL(comment_count, 0) - 1)
        WHERE id = #{id}
    </update>

    <!-- 更新发布状态 -->
    <update id="updatePublishStatus">
        UPDATE t_article
        SET status = #{status},
            publish_time = CASE
                WHEN #{status} = 'PUBLISHED' AND publish_time IS NULL THEN NOW()
                ELSE publish_time
            END
        WHERE id = #{id}
    </update>

    <!-- 查询草稿文章 -->
    <select id="selectDraftArticles" resultType="com.example.blog.entity.Article">
        SELECT id, title, summary, cover_image, status, view_count, like_count, comment_count,
               is_top, author_id, category_id, create_time, update_time
        FROM t_article
        WHERE author_id = #{authorId} AND status = 'DRAFT'
        ORDER BY update_time DESC
    </select>

    <!-- 查询已发布文章 -->
    <select id="selectPublishedArticles" resultType="com.example.blog.entity.Article">
        SELECT id, title, summary, cover_image, status, view_count, like_count, comment_count,
               is_top, author_id, category_id, create_time, update_time, publish_time
        FROM t_article
        WHERE author_id = #{authorId} AND status = 'PUBLISHED'
        ORDER BY publish_time DESC
    </select>

</mapper>