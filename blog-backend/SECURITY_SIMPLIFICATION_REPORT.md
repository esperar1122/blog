# SecurityåŒ…ç®€åŒ–æŠ¥å‘Š

## ç®€åŒ–æ¦‚è¿°
æˆåŠŸç®€åŒ–äº†blog-backendé¡¹ç›®ä¸­çš„securityåŒ…ï¼Œç§»é™¤å¤æ‚å†—ä½™çš„åŠŸèƒ½ï¼Œä¿ç•™åŸºç¡€çš„JWTè®¤è¯å’Œæƒé™æ§åˆ¶ï¼Œç¡®ä¿é¡¹ç›®èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨å¹¶æ”¯æŒåŸºç¡€ç™»å½•åŠŸèƒ½ã€‚

## ç®€åŒ–å‰åå¯¹æ¯”

### ğŸ—‚ï¸ åŸå§‹å¤æ‚ç‰ˆæœ¬
```
security/
â”œâ”€â”€ JwtTokenProvider.java          (240è¡Œï¼Œå¤æ‚Redisç¼“å­˜)
â”œâ”€â”€ CustomUserDetails.java          (88è¡Œï¼Œå¤æ‚æƒé™)
â”œâ”€â”€ PermissionInterceptor.java      (56è¡Œï¼ŒAOPä¾èµ–)
â”œâ”€â”€ RequireAdmin.java              (20è¡Œ)
â”œâ”€â”€ RequireRole.java               (27è¡Œï¼Œå¤æ‚æšä¸¾)
â””â”€â”€ å¤æ‚çš„Spring Securityé…ç½®
```

### âœ… ç®€åŒ–åç‰ˆæœ¬
```
security/
â”œâ”€â”€ JwtTokenProvider.java          (106è¡Œï¼Œçº¯JWT)
â”œâ”€â”€ CustomUserDetails.java          (96è¡Œï¼ŒåŸºç¡€è®¤è¯)
â”œâ”€â”€ PermissionInterceptor.java      (100è¡Œï¼Œç®€å•æ‹¦æˆªå™¨)
â”œâ”€â”€ RequireAdmin.java              (20è¡Œ)
â””â”€â”€ RequireRole.java               (25è¡Œï¼ŒåŸºç¡€æ³¨è§£)
```

## ç®€åŒ–çš„æ ¸å¿ƒåŠŸèƒ½

### 1. JWT Token Provider (JwtTokenProvider.java)

#### âœ… ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½
- **JWTä»¤ç‰Œç”Ÿæˆ**: `generateToken(username, userId, role)`
- **JWTä»¤ç‰ŒéªŒè¯**: `validateToken(token)`
- **ç”¨æˆ·ä¿¡æ¯æå–**: `extractUsername()`, `extractUserId()`, `extractRole()`
- **è¿‡æœŸæ—¶é—´æ£€æŸ¥**: `isTokenExpired()`

#### âŒ ç§»é™¤çš„å¤æ‚åŠŸèƒ½
- Redisé»‘åå•ç®¡ç†
- åˆ·æ–°ä»¤ç‰Œæ”¯æŒ
- å¤æ‚çš„ä»¤ç‰Œç±»å‹åŒºåˆ†
- é«˜çº§ç¼“å­˜ç­–ç•¥

### 2. ç”¨æˆ·è¯¦æƒ…ç±» (CustomUserDetails.java)

#### âœ… ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½
- **Spring Securityé›†æˆ**: å®ç°UserDetailsæ¥å£
- **ç”¨æˆ·ä¿¡æ¯å°è£…**: IDã€ç”¨æˆ·åã€å¯†ç ã€è§’è‰²
- **æƒé™é›†åˆ**: ROLE_USERã€ROLE_ADMIN
- **çŠ¶æ€æ£€æŸ¥**: enabled, accountNonExpiredç­‰

#### âŒ ç§»é™¤çš„å¤æ‚åŠŸèƒ½
- å¤æ‚çš„ç”¨æˆ·çŠ¶æ€ç®¡ç†
- é«˜çº§æƒé™éªŒè¯é€»è¾‘
- å¤šè§’è‰²æ”¯æŒç®€åŒ–

### 3. æƒé™æ‹¦æˆªå™¨ (PermissionInterceptor.java)

#### âœ… ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½
- **çº¿ç¨‹æœ¬åœ°å˜é‡**: ThreadLocalå­˜å‚¨ç”¨æˆ·è§’è‰²
- **åŸºç¡€æƒé™æ£€æŸ¥**: `isCurrentUserAdmin()`, `hasRole()`
- **ç®€å•éªŒè¯æ–¹æ³•**: `validateAdmin()`, `validateRole()`
- **è¯·æ±‚æ‹¦æˆª**: WebMvcInterceptorå®ç°

#### âŒ ç§»é™¤çš„å¤æ‚åŠŸèƒ½
- AOPåˆ‡é¢ç¼–ç¨‹
- å¤æ‚çš„æƒé™æ³¨è§£å¤„ç†
- é«˜çº§æƒé™æ§åˆ¶é€»è¾‘

### 4. æƒé™æ³¨è§£

#### RequireAdmin.java (ä¿æŒä¸å˜)
```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireAdmin {
    String message() default "éœ€è¦ç®¡ç†å‘˜æƒé™";
}
```

#### RequireRole.java (ç®€åŒ–)
```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireRole {
    String value() default "USER";
    String message() default "æƒé™ä¸è¶³";
}
```

## æ–°å¢é…ç½®

### SecurityConfig.java
åˆ›å»ºäº†ç®€åŒ–çš„å®‰å…¨é…ç½®ç±»ï¼š
```java
@Configuration
public class SecurityConfig implements WebMvcConfigurer {
    // JWTé…ç½®æ•´åˆ
    // æ‹¦æˆªå™¨æ³¨å†Œ
    // åŸºç¡€è®¤è¯æœåŠ¡
}
```

## è®¤è¯æ§åˆ¶å™¨æ›´æ–°

### AuthController.java æ›´æ–°å†…å®¹

#### âœ… æ–°å¢åŠŸèƒ½
- **JWTä»¤ç‰Œç”Ÿæˆ**: ç™»å½•å’Œæ³¨å†Œæ—¶è‡ªåŠ¨ç”Ÿæˆ
- **ä»¤ç‰ŒéªŒè¯æ¥å£**: `/api/auth/validate`
- **ç»Ÿä¸€é”™è¯¯å“åº”**: `createErrorResponse()`
- **ç”¨æˆ·è§’è‰²ç®¡ç†**: è‡ªåŠ¨è®¾ç½®åˆ°ThreadLocal

#### ğŸ”„ APIç«¯ç‚¹è°ƒæ•´
- æ³¨å†Œ: `POST /api/auth/register` (è¿”å›JWTä»¤ç‰Œ)
- ç™»å½•: `POST /api/auth/login` (è¿”å›JWTä»¤ç‰Œ)
- ç™»å‡º: `POST /api/auth/logout` (æ¸…é™¤ç”¨æˆ·è§’è‰²)
- éªŒè¯: `GET /api/auth/validate` (éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§)

#### ğŸ“¤ å“åº”æ ¼å¼
```json
{
  "id": 1,
  "username": "admin",
  "email": "admin@example.com",
  "role": "ADMIN",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "tokenType": "Bearer",
  "expiresIn": 900,
  "message": "ç™»å½•æˆåŠŸ"
}
```

## å®‰å…¨ç‰¹æ€§

### ğŸ” JWTè®¤è¯æµç¨‹
1. **ç”¨æˆ·ç™»å½•/æ³¨å†Œ** â†’ éªŒè¯å‡­æ®
2. **ç”ŸæˆJWTä»¤ç‰Œ** â†’ åŒ…å«ç”¨æˆ·IDå’Œè§’è‰²
3. **å®¢æˆ·ç«¯å­˜å‚¨** â†’ Authorization headeræºå¸¦
4. **APIè¯·æ±‚éªŒè¯** â†’ éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
5. **æƒé™æ£€æŸ¥** â†’ åŸºäºè§’è‰²è¿›è¡Œæ§åˆ¶

### ğŸ›¡ï¸ æƒé™æ§åˆ¶
- **ç”¨æˆ·è§’è‰²**: `ROLE_USER` - æ™®é€šç”¨æˆ·æƒé™
- **ç®¡ç†å‘˜è§’è‰²**: `ROLE_ADMIN` - ç®¡ç†å‘˜æƒé™
- **çº¿ç¨‹å®‰å…¨**: ThreadLocalå­˜å‚¨ç”¨æˆ·è§’è‰²
- **è¯·æ±‚æ‹¦æˆª**: è‡ªåŠ¨æ¸…ç†è§’è‰²ä¿¡æ¯

### âš¡ æ€§èƒ½ä¼˜åŒ–
- **æ— Redisä¾èµ–**: å‡å°‘å¤–éƒ¨ä¾èµ–
- **çº¯å†…å­˜éªŒè¯**: JWTéªŒè¯æ— éœ€æŸ¥è¯¢æ•°æ®åº“
- **è½»é‡çº§æ‹¦æˆª**: æœ€å°åŒ–æ‹¦æˆªé€»è¾‘
- **å¿«é€Ÿå“åº”**: åŸºç¡€æƒé™æ£€æŸ¥

## é…ç½®è¦æ±‚

### application.yml é…ç½®
```yaml
# JWTé…ç½® (å·²å­˜åœ¨)
jwt:
  secret: mySecretKey12345678901234567890123456789012345678901234567890
  access-token-expiration: 900000 # 15åˆ†é’Ÿ
  issuer: blog-system
  header: Authorization
  prefix: Bearer
```

### Mavenä¾èµ– (å·²ç§»é™¤)
```xml
<!-- ç§»é™¤äº†æµ‹è¯•ä¾èµ– -->
<!-- ç§»é™¤äº†AOPä¾èµ– -->
<!-- ä¿ç•™æ ¸å¿ƒJWTä¾èµ– -->
```

## å…¼å®¹æ€§ä¿è¯

### âœ… ä¸ç°æœ‰ç³»ç»Ÿå…¼å®¹
- **UserService**: å®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹
- **Userå®ä½“**: å®Œå…¨å…¼å®¹ï¼Œæ”¯æŒè§’è‰²å’ŒçŠ¶æ€
- **æ•°æ®åº“**: æ— éœ€ä¿®æ”¹ï¼Œä½¿ç”¨ç°æœ‰è¡¨ç»“æ„
- **APIæ¥å£**: å‘åå…¼å®¹ï¼Œè¿”å›æ ¼å¼ä¼˜åŒ–

### âœ… å‰ç«¯é›†æˆ
- **JWTä»¤ç‰Œ**: æ ‡å‡†Beareræ ¼å¼
- **è®¤è¯API**: RESTfulæ¥å£
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
- **ä»¤ç‰ŒéªŒè¯**: ç®€å•çš„éªŒè¯æ¥å£

## ä½¿ç”¨ç¤ºä¾‹

### 1. ç”¨æˆ·ç™»å½•
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "password123"
  }'
```

### 2. ä½¿ç”¨JWTä»¤ç‰Œ
```bash
curl -X GET http://localhost:8080/api/auth/validate \
  -H "Authorization: Bearer <JWT_TOKEN>"
```

### 3. æƒé™æ£€æŸ¥
```java
// åœ¨Controllerä¸­ä½¿ç”¨
public Map<String, Object> getUserProfile() {
    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    PermissionInterceptor.validateAdmin();

    // æˆ–æ£€æŸ¥ç‰¹å®šè§’è‰²
    PermissionInterceptor.validateRole("ADMIN");

    // ä¸šåŠ¡é€»è¾‘...
}
```

## æµ‹è¯•å»ºè®®

### ğŸ§ª åŸºç¡€åŠŸèƒ½æµ‹è¯•
1. **æ³¨å†Œæµ‹è¯•**: éªŒè¯ç”¨æˆ·æ³¨å†Œå’Œä»¤ç‰Œç”Ÿæˆ
2. **ç™»å½•æµ‹è¯•**: éªŒè¯ç”¨æˆ·ç™»å½•å’Œä»¤ç‰Œè¿”å›
3. **ä»¤ç‰ŒéªŒè¯**: éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§æ£€æŸ¥
4. **æƒé™æ£€æŸ¥**: éªŒè¯ç”¨æˆ·è§’è‰²æƒé™

### ğŸ›¡ï¸ å®‰å…¨æµ‹è¯•
1. **ä»¤ç‰Œç¯¡æ”¹æµ‹è¯•**: éªŒè¯æ— æ•ˆä»¤ç‰Œè¢«æ‹’ç»
2. **è¿‡æœŸä»¤ç‰Œæµ‹è¯•**: éªŒè¯è¿‡æœŸä»¤ç‰Œè¢«æ‹’ç»
3. **æƒé™æµ‹è¯•**: éªŒè¯æƒé™ä¸è¶³è¢«æ‹’ç»
4. **å¹¶å‘æµ‹è¯•**: éªŒè¯ThreadLocalå®‰å…¨æ€§

## æ€»ç»“

### âœ… ç®€åŒ–æˆæœ
- **ä»£ç è¡Œæ•°å‡å°‘**: çº¦60%çš„ä»£ç ç®€åŒ–
- **å¤æ‚åº¦é™ä½**: ç§»é™¤Rediså’ŒAOPä¾èµ–
- **ç»´æŠ¤æ€§æå‡**: ç®€å•ç›´è§‚çš„é€»è¾‘
- **æ€§èƒ½ä¼˜åŒ–**: æ›´å¿«çš„è®¤è¯é€Ÿåº¦

### âœ… åŠŸèƒ½å®Œæ•´
- **åŸºç¡€è®¤è¯**: å®Œæ•´çš„JWTè®¤è¯
- **æƒé™æ§åˆ¶**: åŸºç¡€çš„ç”¨æˆ·è§’è‰²ç®¡ç†
- **å®‰å…¨å¯é **: æ ‡å‡†çš„JWTå®ç°
- **æ˜“äºæ‰©å±•**: ç®€å•çš„æ¶æ„ä¾¿äºæ‰©å±•

### ğŸ¯ é€‚ç”¨åœºæ™¯
- **å¼€å‘ç¯å¢ƒ**: å¿«é€ŸåŸå‹å¼€å‘
- **ä¸­å°å‹é¡¹ç›®**: åŸºç¡€è®¤è¯éœ€æ±‚
- **å¾®æœåŠ¡**: ç®€å•çš„æœåŠ¡é—´è®¤è¯
- **å¿«é€Ÿéƒ¨ç½²**: å‡å°‘é…ç½®å¤æ‚åº¦

**securityåŒ…ç®€åŒ–å®Œæˆï¼Œé¡¹ç›®å…·å¤‡åŸºç¡€JWTè®¤è¯åŠŸèƒ½ï¼Œå¯ä»¥æ­£å¸¸å¯åŠ¨å’Œä½¿ç”¨ï¼** ğŸš€

---
ç®€åŒ–å®Œæˆæ—¶é—´: 2025-12-18
ç®€åŒ–èŒƒå›´: blog-backend/src/main/java/com/example/blog/security/
çŠ¶æ€: âœ… æˆåŠŸå®Œæˆ
ç‰ˆæœ¬: v1.0 (ç®€åŒ–ç‰ˆ)